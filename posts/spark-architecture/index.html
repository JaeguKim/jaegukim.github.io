<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Spark Architecture" /><meta name="author" content="Jaegoo Kim" /><meta property="og:locale" content="en" /><meta name="description" content="Spark의 동작방식" /><meta property="og:description" content="Spark의 동작방식" /><link rel="canonical" href="https://jaegukim.github.io/posts/spark-architecture/" /><meta property="og:url" content="https://jaegukim.github.io/posts/spark-architecture/" /><meta property="og:site_name" content="Study Log" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-25T13:56:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spark Architecture" /><meta name="twitter:site" content="@JaeguKim" /><meta name="twitter:creator" content="@Jaegoo Kim" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jaegoo Kim"},"dateModified":"2021-03-26T21:54:36+08:00","datePublished":"2021-02-25T13:56:00+08:00","description":"Spark의 동작방식","headline":"Spark Architecture","mainEntityOfPage":{"@type":"WebPage","@id":"https://jaegukim.github.io/posts/spark-architecture/"},"url":"https://jaegukim.github.io/posts/spark-architecture/"}</script><title>Spark Architecture | Study Log</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Study Log"><meta name="application-name" content="Study Log"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/22807942?s=460&u=cc1d822a8be2c87ac3aa4917adaadeca5487c515&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Study Log</a></div><div class="site-subtitle font-italic">“ In order to be irreplaceable, one must always be different” – Coco Chanel</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/JaeguKim" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/JaeguKim" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kimwithglasses','kakao.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spark Architecture</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spark Architecture</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Jaegoo.Kim </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Feb 25, 2021, 1:56 PM +0800" >Feb 25, 2021<i class="unloaded">2021-02-25T13:56:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Mar 26, 2021, 10:54 PM +0900" >Mar 26, 2021<i class="unloaded">2021-03-26T21:54:36+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="751 words">4 min read</span></div></div><div class="post-content"><h1 id="spark의-동작방식">Spark의 동작방식</h1><p><img data-proofer-ignore data-src="https://d2h0cx97tjks2p.cloudfront.net/blogs/wp-content/uploads/sites/2/2017/08/Internals-of-job-execution-in-spark.jpg" alt="img" /></p><ol><li>spark-submit을 사용해서, application을 제출한다.<li>spark-submit이 명시된 jar의 main() 함수를 실행하고, driver를 실행한다.<li>driver는 sparkContext를 생성하고, cluster manager(eg. MESOS, YARN)에게 자원을 요청한다.<li>cluster manager가 driver를 대신해서 executor를 실행한다.<li>driver는 task를 executor에게 보낸다.<li>executor는 task를 실행하고 결과를 cluster manager를 통해서 driver에게 보낸다.</ol><h1 id="spark-용어">Spark 용어</h1><h2 id="sparkcontext">SparkContext</h2><p>Spark RDD, accumulator, broadcast variable을 생성하고 Spark job을 실행한다. 주로 다음 일을 한다.</p><ul><li>spark application의 현재 상태 얻기<li>job을 취소하기<li>Stage 취소하기<li>job을 비동기/동기로 실행하기</ul><h2 id="sparkshell">SparkShell</h2><p>command line 환경 제공</p><h2 id="job">Job</h2><p>action에 의해서 생성되는 일련의 RDD에 대한 transformation. job은 여러 stage로 구성된다.</p><h2 id="stage">Stage</h2><p>단일 워커에 의해 실행될수 있고 파이프라인 될수 있는 일련의 Transformation. 여러 task로 구성된다.</p><h2 id="task">Task</h2><p>spark에 의해서 수행되는 작업의 단위로 executor JVM에서 하나의 스레드로 동작한다. 하나의 task에 하나의 partition이 맵핑된다.</p><h2 id="partition">Partition</h2><p>데이터를 읽기위한 대부분의 메소드에서 RDD에대한 partition수를 명시할수 있다. HDFS에서 파일을 읽을때는 Hadoop InputFormat을 사용한다. 디폴트로는 InputFormat에 의해서 리턴된 각각의 input split은 RDD에 있는 하나의 partition으로 맵핑된다. HDFS상의 대부분의 파일에서 input split은 HDFS위에서 저장된 단일 데이터 블록당 하나로 대응된다. 데이터 블록 사이즈는 대략 64MB 또는 128MB 정도이다. 대략적으로 HDFS상의 데이터는 정확히 블록 단위로 나누어지고 처리될때 record splits 나누어진다. text file에서는 splitting character는 newline char이지만 sequence file에서는 block end이다. 압축파일에서는 예외가 있는데 - 전체 텍스트 파일이 압축되있다면 전체파일이 하나의 input split, partition이 되므로 수동으로 repartition 해야한다.</p><p>여기서 단일 partition 데이터를 처리하기위해서, spark은 하나의 task를 생성한다, task는 데이터와 가까이 위치한 task slot에서(Hadoop block location, Spark cached paritition location) 실행된다.</p><h2 id="spark-application">Spark Application</h2><p>SparkContext의 단일 인스턴스이고, 데이터 프로세싱 로직을 저장하고 일련의 Job을 실행</p><h2 id="driver">Driver</h2><ul><li><p>Spark Shell(Scala, Python, R)에 대한 entry point</p><li><p>SparkContext가 생성되는 곳</p><li><p>RDD를 execution graph로 변환</p><li><p>graph를 여러 stage로 나눔</p><li><p>task를 스케줄하고 실행을 통제</p><li><p>RDD와 파티션에 대한 메타데이터 저장</p></ul><h2 id="executor">Executor</h2><p><img data-proofer-ignore data-src="https://i2.wp.com/0x0fff.com/wp-content/uploads/2015/03/Spark-Architecture-On-YARN.png" alt="img" /></p><ul><li><p>JVM heap or HDD에 데이터 저장</p><li><p>외부 저장소로부터 데이터 읽어들임</p><li><p>외부 저장소에 데이터를 씀</p><li><p>데이터 프로세싱 수행</p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dataengineering/'>DataEngineering</a>, <a href='/categories/spark/'>Spark</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spark Architecture - Study Log&url=https://jaegukim.github.io/posts/spark-architecture/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spark Architecture - Study Log&u=https://jaegukim.github.io/posts/spark-architecture/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Spark Architecture - Study Log&url=https://jaegukim.github.io/posts/spark-architecture/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/software-engineering-at-google/">Software Engineering at Google</a><li><a href="/posts/til/">TIL</a><li><a href="/posts/custom-default-backend-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0/">custom error page 띄우기</a><li><a href="/posts/cors-setting/">CORS setting</a><li><a href="/posts/helm-chart/">Helm Chart</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spark/"><div class="card-body"> <span class="timeago small" >Sep 24, 2020<i class="unloaded">2020-09-24T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spark와 Data Engineering 관련 프로젝트 시작하기</h3><div class="text-muted small"><p> What Is Spark? Open-source distributed general-purpose cluster-computing framework. How to start data engineering projects? Choose any framework, let’s say Kafka. Write some codes using that ...</p></div></div></a></div><div class="card"> <a href="/posts/rdds-vs-dataframes-and-datasets/"><div class="card-body"> <span class="timeago small" >Feb 2, 2021<i class="unloaded">2021-02-02T17:39:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>RDDs vs DataFrames vs Datasets</h3><div class="text-muted small"><p> Resilient Distributed Dataset(RDD) RDD는 데이터의 immutable distributed collection, 클러스터의 노드들에 분할되어있고 병렬적으로 처리됨. 여러 분산 노드에 걸쳐서 저장되는 변경이 불가능한 데이터(객체)의 집합으로 각각의 RDD는 여러개의 파티션으로 분리가 됩니다. 즉, 스파크 내에 저장된 데이터...</p></div></div></a></div><div class="card"> <a href="/posts/%EC%A4%91%EC%B2%A9%EB%90%9C-schema-flattening%ED%95%98%EA%B8%B0/"><div class="card-body"> <span class="timeago small" >Feb 10, 2021<i class="unloaded">2021-02-10T08:56:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>중첩된 schema flattening하기</h3><div class="text-muted small"><p> def flattenSchema(schema: StructType, prefix: String = null): Array[Column] = { schema.fields.flatMap(f =&gt; { val colName = if (prefix == null) f.name else (prefix + "." + f.name) ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/executor-%EC%9E%90%EC%9B%90-%EA%B2%B0%EC%A0%95%ED%95%98%EA%B8%B0/" class="btn btn-outline-primary" prompt="Older"><p>Executor 자원 결정하기</p></a> <a href="/posts/spark-vs-mapreduce/" class="btn btn-outline-primary" prompt="Newer"><p>Spark vs MapReduce</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//jaegukim.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Spark Architecture'; this.page.url = 'https://jaegukim.github.io/posts/spark-architecture/'; this.page.identifier = '/posts/spark-architecture/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Jaegoo.Kim</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://jaegukim.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
